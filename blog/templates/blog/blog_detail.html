{% extends "layout.html" %}
<!-- Load Stuff -->
{% load static %} {% load markdown_extras %}

<!-- Title -->
{% block title %}{{post.title}}{% endblock title %}

<!-- Blog Post -->
{% block content %}
<!-- Post Info -->
<div class="flex flex-column mb-1">
    <div class="flex align-center justify-between mb-half">
        <p class="fs-small fc-light">Published on {{post.created_at|date:"F d, Y"}}</p>
        <!-- Actions Buttons -->
        {% if request.user.is_authenticated and request.user == post.author %}
        <div style="display: flex; gap: 1rem">
            <!-- Edit Button -->
            <a href="{% url 'edit_post' post.slug %}" class="btn btn-tertiary">Edit Post</a>
            <!-- Delete Button (Form) -->
            <form action="{% url 'delete_post' post.slug %}" method="post">
                {% csrf_token %}
                <button type="submit" class="btn btn-tertiary btn-danger">Delete Post</button>
            </form>
        </div>
        {% endif %}
    </div>

    <div>
        <h1 class="heading-main">{{post.title}}</h1>
        <!-- Only if caption available -->
        <p>{% if post.caption %} {{post.caption}} {% else %} No Caption. {% endif %}</p>
    </div>

    <!-- User -->
    <div class="flex align-center gap-10 mt-1">
        <!-- Avatar -->
        {% if post.author.profile.profile_picture %}
        <img src="{{post.author.profile.profile_picture.url}}" alt="" class="avatar avatar-small" />
        {% else %}
        <img src="{% static 'icons/avatar.svg' %}" alt="" class="avatar avatar-small" />
        {% endif %}

        <!-- Profile Details -->
        <div class="flex align-center gap-20">
            {% if post.author %}
            <!-- Header -->
            <div class="flex flex-column justify-between">
                <a href="{% url 'users:user_profile' post.author.username %}" class="link-secondary fw-bold"
                    >{{post.author}}</a
                >
                <p class="fs-small">{{post.author.followers.count}} Followers</p>
            </div>
            {% else %}
            <!-- User was deleted -->
            <div class="flex flex-column justify-between">
                <span class="fw-bold error-text"><strike>user-deleted</strike></span>
                <!-- <p class="fs-small">0 Followers</p> -->
            </div>
            {% endif %}

            <!-- If user is not author and author is not deleted -->
            {% if request.user != post.author and post.author %}
            <!-- Follow/Unfollow button -->
            {% if not already_following %}
            <a href="{% url 'users:follow_user' post.author.username %}" class="btn btn-primary">Follow</a>
            {% else %}
            <!-- Unfollow button -->
            <a href="{% url 'users:unfollow_user' post.author.username %}" class="btn btn-tertiary">Unfollow</a>
            {% endif %}
            <!--  -->
            {% endif %}
        </div>
    </div>
</div>

<hr />

<!-- Post Content Container (MARKDOWN) -->
<div class="content-container mt-1 mb-2 markdown">{{post.content|markdownify|safe}}</div>
<!-- Post END -->

<!-- Category -->
{% if post.category %}
<div class="card-footer mb-1">
    <span>
        Category:
        <a href="{% url 'explore_category' post.category.slug %}" class="tag-pill">{{post.category}}</a>
    </span>
</div>
{% endif %}

<!-- Tags -->
{% if post.tags.all %}
<div class="card-footer mb-1">
    <span>
        Tags:
        <!-- Iterate tags -->
        {% for tag in post.tags.all %}
        <a class="tag-pill" href="{% url 'explore_tag' tag.name %}">{{tag.name}}</a>
        {% endfor %}
    </span>
</div>
{% endif %}

<!-- Metadata -->
<hr />
<div class="flex justify-between mt-half mb-half">
    <span class="card-likes-comments">
        <!-- Like (Icon Button) -->
        <form action="{% url 'like_post' post.slug %}" method="post" class="icon-text-container">
            {% csrf_token %}
            <button type="submit" class="btn btn-icon {% if post_liked %}btn-icon-active{% endif %}">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="48" height="48">
                    <path
                        d="M16.5,3C13.605,3,12,5.09,12,5.09S10.395,3,7.5,3C4.462,3,2,5.462,2,8.5c0,4.171,4.912,8.213,6.281,9.49 C9.858,19.46,12,21.35,12,21.35s2.142-1.89,3.719-3.36C17.088,16.713,22,12.671,22,8.5C22,5.462,19.538,3,16.5,3z" />
                </svg>
            </button>
            {{post.likes.count}}
        </form>

        <!-- Comments -->
        <span class="icon-text-container">
            <img src="{% static 'icons/icons8_topic.svg' %}" alt="" />
            {{post.comments.count}}
        </span>
    </span>

    <!-- Save/Share Buttons -->
    <div class="flex gap-10">
        <!-- Save Post -->
        <form action="{% url 'save_post' post.slug %}" method="post">
            {% csrf_token %}
            <!-- Already Saved? -->
            {% if post_saved %}
            <button class="btn btn-tertiary btn-with-icon btn-with-icon-active">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="48" height="48">
                    <path
                        d="M6 2C5.861875 2 5.7278809 2.0143848 5.5976562 2.0410156C4.686084 2.2274316 4 3.033125 4 4L4 22L12 19L20 22L20 4C20 3.8625 19.985742 3.7275391 19.958984 3.5976562C19.799199 2.8163086 19.183691 2.2008008 18.402344 2.0410156C18.272119 2.0143848 18.138125 2 18 2L6 2 z" />
                </svg>
                Saved
            </button>
            {% else %}
            <button type="submit" class="btn btn-tertiary btn-with-icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="48" height="48">
                    <path
                        d="M6.0097656 2C4.9143111 2 4.0097656 2.9025988 4.0097656 3.9980469L4 22L12 19L20 22L20 20.556641L20 4C20 2.9069372 19.093063 2 18 2L6.0097656 2 z M 6.0097656 4L18 4L18 19.113281L12 16.863281L6.0019531 19.113281L6.0097656 4 z" />
                </svg>
                Save
            </button>
            {% endif %}
        </form>

        <!-- Share Post -->
        <button class="btn btn-tertiary btn-with-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="96" height="96">
                <path
                    d="M16.707031 2.2929688L15.292969 3.7070312L17.585938 6L17 6C10.936593 6 6 10.936593 6 17L6 18L8 18L8 17C8 12.017407 12.017407 8 17 8L17.585938 8L15.292969 10.292969L16.707031 11.707031L21.414062 7L16.707031 2.2929688 z M 2 8L2 9L2 19C2 20.64497 3.3550302 22 5 22L19 22C20.64497 22 22 20.64497 22 19L22 18L22 17L20 17L20 18L20 19C20 19.56503 19.56503 20 19 20L5 20C4.4349698 20 4 19.56503 4 19L4 9L4 8L2 8 z" />
            </svg>

            Share
        </button>
    </div>
</div>
<hr />

<!-- Comments Section -->
<div class="comments-section mt-2 mb-1">
    <h2>Comments ({{post.comments.count}})</h2>
    <!-- Comment Box -->
    <form
        action="{% url 'comment_on_post' post.slug %}"
        method="post"
        class="comment-box mt-1 flex flex-column align-end">
        {% csrf_token %}
        <!-- Comment Content Field -->
        {{comment_form.content}}
        <button type="submit" class="btn btn-primary mt-half">Comment</button>
    </form>

    <!-- Comments-->
    <div>
        {% if post.comments.count %}
        <!-- Iterate Comments -->
        {% for comment in post.comments.all %}
        <div class="mt-1 mb-1">
            <!-- Head -->
            <div class="flex gap-10 align-center">
                <!-- Avatar -->
                {% if comment.user.profile.profile_picture %}
                <img src="{{comment.user.profile.profile_picture.url}}" alt="" class="avatar avatar-small" />
                {% else %}
                <div class="avatar avatar-small"></div>
                {% endif %}

                <!-- User -->
                <div class="flex flex-column justify-between">
                    <!-- If Comment-writer not deleted -->
                    {% if comment.user %}
                    <a href="{% url 'users:user_profile' comment.user.username %}" class="link-secondary"
                        >{{comment.user}}</a
                    >
                    {% else %}
                    <span class="error-text"><strike>user-deleted</strike></span>
                    {% endif %}
                    <p class="fs-small fc-light">about {{comment.created_at|timesince}} ago</p>
                </div>
            </div>

            <!-- Body -->
            <div class="mt-half">
                <p>{{comment.content}}</p>
            </div>
        </div>
        <hr />
        {% endfor %}
        <button class="btn btn-tertiary mt-1">See all comments</button>
        {% endif %}
    </div>
</div>
<hr />

<!-- Author Deleted? -->
{% if post.author %}

<!-- Author's other posts (CARDS) -->
<div class="mt-1">
    <h2 class="fc-normal">More from <span class="fc-darker">{{post.author}}</span></h2>

    <!-- Cards Container -->
    <div class="card-compact-container">
        {% for user_post in user_posts %}
        <!-- Card -->
        <div class="card-compact">
            <div class="flex flex-column gap-10">
                <!-- Image -->
                <div class="card-compact-img-container">
                    {% if user_post.cover_image %}
                    <img src="{{user_post.cover_image.url}}" alt="{{user_post.slug}}-cover" class="" />
                    {% else %}
                    <img src="{% static 'icons/default-image.png' %}" alt="{{user_post.slug}}-cover" class="" />
                    {% endif %}
                </div>

                <!-- Info -->
                <div class="flex flex-column gap-5">
                    <!-- Title -->
                    <a href="{% url 'blog_detail' user_post.slug %}" class="card-title fw-bold"
                        >{{user_post.title|truncatechars:70}}</a
                    >

                    <!-- Caption -->
                    <p class="card-caption">
                        {% if user_post.caption %}
                        <!-- Only if caption available -->
                        {{user_post.caption|truncatechars:70}} {% else %}
                        <!-- Default -->
                        No Caption. {% endif %}
                    </p>
                </div>
            </div>

            <!-- Footer -->
            <div class="card-content-meta-container">
                <span class="card-likes-comments">
                    <!-- Likes -->
                    <span class="icon-text-container">
                        <form action="{% url 'like_post' user_post.slug %}" method="post">
                            {% csrf_token %}
                            <input type="submit" value="Like" />
                        </form>
                        <img src="{% static 'icons/icons8_heart.svg' %}" alt="" />
                        {{user_post.likes.count}}
                    </span>

                    <!-- Comments -->
                    <span class="icon-text-container">
                        <img src="{% static 'icons/icons8_topic.svg' %}" alt="" />
                        {{user_post.comments.count}}
                    </span>
                </span>

                <span>{{user_post.created_at|date:"F d, Y"}}</span>
            </div>
        </div>
        {% endfor %}
    </div>

    <hr />
    <a href="{% url 'users:user_profile' post.author.username %}" class="btn btn-tertiary mt-1"
        >See all from <span class="fw-bold">{{post.author}}</span></a
    >
</div>

{% endif %} {% endblock content %}
